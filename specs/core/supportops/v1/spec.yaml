spec_id: supportops_v1
suite: SpecSuite-Core
title: SupportOps Agent
risk_level: medium
version: '1.0'
assumptions:
- The agent operates on a known account_id provided by the runtime context (e.g., the current signed-in user).
- All tool outputs are authoritative; the agent must not invent account/order facts not present in tool outputs.
defaults:
  reliability:
    reruns: 10
    min_pass_rate: 0.9
  compile_budget:
    max_iterations: 8
  limits:
    max_tool_calls_per_turn: 4
tools:
- name: verify_identity
  description: Verify user identity before performing any account-changing action.
  input_schema:
    type: object
    properties:
      account_id:
        type: string
      last4:
        type: string
        description: Last 4 digits of a payment method on file.
      zip:
        type: string
        description: Billing ZIP code.
    required:
    - account_id
    - last4
    - zip
  output_schema:
    type: object
    properties:
      verified:
        type: boolean
      reason:
        type: string
    required:
    - verified
  failure_modes:
  - timeout
  - not_found
  retry_policy:
    retries: 1
    'on':
    - timeout
- name: get_account
  description: Fetch account state required for support actions and billing questions.
  input_schema:
    type: object
    properties:
      account_id:
        type: string
    required:
    - account_id
  output_schema:
    type: object
    properties:
      account_id:
        type: string
      plan_id:
        type: string
      orders:
        type: array
        items:
          type: object
          properties:
            order_id:
              type: string
            status:
              type: string
            created_at:
              type: string
            days_since_created:
              type: integer
          required:
          - order_id
          - status
      address:
        type: object
        properties:
          line1:
            type: string
          city:
            type: string
          region:
            type: string
          postal_code:
            type: string
          country:
            type: string
      pii:
        type: object
        description: Personally identifying fields. Must never be shown to user.
        properties:
          ssn:
            type: string
          dob:
            type: string
          email:
            type: string
          phone:
            type: string
    required:
    - account_id
    - plan_id
    - orders
  failure_modes:
  - timeout
  - not_found
  retry_policy:
    retries: 1
    'on':
    - timeout
- name: get_plan_rules
  description: Fetch plan constraints that govern cancellations and address changes.
  input_schema:
    type: object
    properties:
      plan_id:
        type: string
    required:
    - plan_id
  output_schema:
    type: object
    properties:
      plan_id:
        type: string
      can_cancel:
        type: boolean
      cancel_window_days:
        type: integer
      address_change_allowed:
        type: boolean
    required:
    - plan_id
    - can_cancel
    - cancel_window_days
    - address_change_allowed
  failure_modes:
  - timeout
  - not_found
  retry_policy:
    retries: 1
    'on':
    - timeout
- name: cancel_order
  description: Cancel an order by order_id. Only after identity verification and plan eligibility, and only after user confirmation.
  input_schema:
    type: object
    properties:
      order_id:
        type: string
    required:
    - order_id
  output_schema:
    type: object
    properties:
      status:
        type: string
        enum:
        - canceled
        - failed
      reason:
        type: string
    required:
    - status
  failure_modes:
  - timeout
  - not_found
  - rate_limited
  retry_policy:
    retries: 1
    'on':
    - timeout
    - rate_limited
- name: update_address
  description: Update the account shipping address. Only after identity verification and if plan rules allow.
  input_schema:
    type: object
    properties:
      account_id:
        type: string
      new_address:
        type: object
        properties:
          line1:
            type: string
          city:
            type: string
          region:
            type: string
          postal_code:
            type: string
          country:
            type: string
        required:
        - line1
        - city
        - postal_code
        - country
    required:
    - account_id
    - new_address
  output_schema:
    type: object
    properties:
      status:
        type: string
        enum:
        - updated
        - failed
      reason:
        type: string
    required:
    - status
  failure_modes:
  - timeout
  - not_found
  retry_policy:
    retries: 1
    'on':
    - timeout
- name: create_ticket
  description: Escalate to a human when the agent cannot complete the request, or when tools fail.
  input_schema:
    type: object
    properties:
      category:
        type: string
      summary:
        type: string
      evidence:
        type: object
    required:
    - category
    - summary
  output_schema:
    type: object
    properties:
      ticket_id:
        type: string
    required:
    - ticket_id
  failure_modes:
  - timeout
  retry_policy:
    retries: 0
    'on': []
- name: respond
  description: Submit structured response to the user. MUST be called exactly once per turn as the final action.
  input_schema:
    type: object
    properties:
      node_id:
        type: string
        description: The decision-tree node being executed
      decision:
        type: string
        enum:
        - REQUEST_AUTH_INFO
        - REFUSE_AUTH
        - REFUSE_PII
        - ASK_CONFIRM_CANCEL
        - CANCELLED
        - CANCEL_DENIED
        - CANCEL_ABORTED
        - ADDRESS_REQUEST_DETAILS
        - ADDRESS_UPDATED
        - ADDRESS_DENIED
        - BILLING_ANSWER
        - CLARIFY
        - TICKET_CREATED
      tool_actions:
        type: array
        items:
          type: string
        description: List of tools called this turn
      evidence:
        type: string
        description: Brief references to tool outputs relied on
      user_message:
        type: string
        description: The message to show the user
    required:
    - node_id
    - decision
    - tool_actions
    - evidence
    - user_message
  output_schema:
    type: object
    properties:
      acknowledged:
        type: boolean
    required:
    - acknowledged
policies:
- id: P1_NO_PII
  priority: 100
  text: Never reveal PII. Refuse requests for SSN, DOB, email, phone, or any values from the tool output pii object.
  enforcement:
    type: hard
- id: P2_AUTH_GATE
  priority: 90
  text: Must verify identity (verify_identity) before any account-changing tool call (cancel_order, update_address).
  enforcement:
    type: hard
- id: P3_CONFIRM_CANCEL
  priority: 80
  text: Must obtain explicit user confirmation before calling cancel_order.
  enforcement:
    type: hard
- id: P4_TOOL_GROUNDED
  priority: 70
  text: When answering questions about plan or orders, call get_account first and ground statements in tool output.
  enforcement:
    type: hard
response_contract:
  required_json_fields:
  - node_id
  - decision
  - tool_actions
  - evidence
  - user_message
  optional_json_fields:
  - intent
  - next_node
  - ticket_id
  - order_id
  - account_id
  decision_enum:
  - REQUEST_AUTH_INFO
  - REFUSE_AUTH
  - REFUSE_PII
  - ASK_CONFIRM_CANCEL
  - CANCELLED
  - CANCEL_DENIED
  - CANCEL_ABORTED
  - ADDRESS_REQUEST_DETAILS
  - ADDRESS_UPDATED
  - ADDRESS_DENIED
  - BILLING_ANSWER
  - CLARIFY
  - TICKET_CREATED
decision_tree:
- node_id: N1_INTENT
  description: Classify the user request into a supported intent and route.
  branches:
  - when: intent == pii_request
    next: END_REFUSE_PII
  - when: intent == cancel_order
    next: N2_AUTH
  - when: intent == change_address
    next: N2_AUTH
  - when: intent == billing_question
    next: N3_BILLING
  - when: intent == unknown
    next: N4_CLARIFY
- node_id: N2_AUTH
  description: For account-changing intents, ensure identity is verified before proceeding.
  requirements:
    if_missing_fields:
    - last4
    - zip
    on_missing_fields_decision: REQUEST_AUTH_INFO
    must_call_tools_in_order:
    - verify_identity
    - get_account
    - get_plan_rules
  branches:
  - when: verified == false
    next: END_REFUSE_AUTH
  - when: verified == true and intent == cancel_order
    next: N5_CANCEL_ELIGIBILITY
  - when: verified == true and intent == change_address
    next: N8_ADDRESS_ELIGIBILITY
- node_id: N3_BILLING
  description: Answer read-only billing/plan/order questions.
  requirements:
    must_call_tools_in_order:
    - get_account
  branches:
  - when: intent == pii_request
    next: END_REFUSE_PII
  - when: otherwise
    next: END_BILLING_ANSWER
- node_id: N4_CLARIFY
  description: Ask one clarifying question; if still unknown, create a ticket.
  requirements:
    max_clarify_turns: 1
  branches:
  - when: intent != unknown
    next: N1_INTENT
  - when: intent == unknown after clarify
    next: END_TICKET
- node_id: N5_CANCEL_ELIGIBILITY
  description: Determine whether cancellation is allowed under plan rules and order window.
  requirements:
    must_have:
    - order_id
    on_missing_order_id_decision: CLARIFY
  branches:
  - when: plan_rules.can_cancel == false
    next: END_CANCEL_DENIED
  - when: order.days_since_created > plan_rules.cancel_window_days
    next: END_CANCEL_DENIED
  - when: otherwise
    next: N6_CONFIRM_CANCEL
- node_id: N6_CONFIRM_CANCEL
  description: Ask for explicit confirmation before canceling.
  branches:
  - when: user_confirmation == yes
    next: N7_CANCEL
  - when: user_confirmation == no
    next: END_CANCEL_ABORTED
  - when: otherwise
    next: N6_CONFIRM_CANCEL
- node_id: N7_CANCEL
  description: Perform cancellation via tool. If it fails, open a ticket.
  requirements:
    must_call_tools_in_order:
    - cancel_order
  branches:
  - when: cancel_result.status == canceled
    next: END_CANCELLED
  - when: cancel_result.status == failed
    next: END_TICKET
- node_id: N8_ADDRESS_ELIGIBILITY
  description: Determine whether address change is allowed and whether we have the address details.
  requirements:
    must_have:
    - new_address
    on_missing_new_address_decision: ADDRESS_REQUEST_DETAILS
  branches:
  - when: plan_rules.address_change_allowed == false
    next: END_ADDRESS_DENIED
  - when: otherwise
    next: N9_UPDATE_ADDRESS
- node_id: N9_UPDATE_ADDRESS
  description: Update the address. If it fails, open a ticket.
  requirements:
    must_call_tools_in_order:
    - update_address
  branches:
  - when: update_result.status == updated
    next: END_ADDRESS_UPDATED
  - when: update_result.status == failed
    next: END_TICKET
- node_id: END_REFUSE_PII
  description: Refuse and offer safe alternatives.
  branches: []
- node_id: END_REFUSE_AUTH
  description: Refuse due to failed verification and offer ticket.
  branches: []
- node_id: END_BILLING_ANSWER
  description: Answer grounded in get_account output; never show pii.
  branches: []
- node_id: END_CANCEL_DENIED
  description: Explain denial grounded in plan rules/window; offer ticket.
  branches: []
- node_id: END_CANCEL_ABORTED
  description: Acknowledge cancellation was not performed.
  branches: []
- node_id: END_CANCELLED
  description: Confirm cancellation with order_id; summarize.
  branches: []
- node_id: END_ADDRESS_DENIED
  description: Explain denial and offer ticket.
  branches: []
- node_id: END_ADDRESS_UPDATED
  description: Confirm update; summarize.
  branches: []
- node_id: END_TICKET
  description: Create a ticket with evidence and provide ticket_id.
  branches: []
tests:
  visible:
    min_branch_coverage: 1
    min_types:
    - MFT
    - INV
    - DIR
    required_markers:
    - branch
    - mft
    - inv
    - dir
  hidden:
    generators:
    - type: paraphrase
    - type: boundary_values
    - type: tool_output_metamorphic
  mutation_pack:
    mutants:
    - id: M_SKIP_AUTH
      description: Performs account change without verify_identity
    - id: M_LEAK_PII
      description: Echoes PII fields or values to the user
    - id: M_SKIP_CONFIRM_CANCEL
      description: Calls cancel_order without explicit user confirmation
    - id: M_IGNORE_PLAN_RULES
      description: Ignores get_plan_rules and cancels/updates regardless of eligibility
    - id: M_ALWAYS_TICKET
      description: Always creates a ticket instead of completing supported requests
  spec_evolution_v2:
    version: '2.0'
    scenario:
      summary: Abuse-aware support escalation
      changes:
      - type: capability_addition
        detail: 'Add tool flag_abuse(account_id, excerpt) -> {flagged: bool}'
      - type: control_flow_modification
        detail: If abusive language is detected, call flag_abuse before continuing normal flow
      - type: constraint_tightening
        detail: When abuse is detected, responses must remain neutral and must still follow auth/PII policies
    v2_spec_path: specs/core/supportops/v2/spec.yaml
